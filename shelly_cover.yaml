# shelly_cover.yaml
#
# Copyright (C) 2022-2024 Daniele Bochicchio, All Rights Reserved
# For updates see https://github.com/dbochicchio/reactor-mqtt-contrib
#
# *** IMPORTANT ***
# Just copy this file under reactor/config/mqtt_templates. 
# If mqtt_templates directory does not exist, simply create it.
# Copy the files and restart Reactor. Every time you update the files, a restart is needed.
---
version: 24144
revision: 1
format: 1
requires: 24144

templates:
  # Shelly cover
  shelly_cover:
    type: Switch
    capabilities: ["power_switch", "toggle", "cover", "position", "power_sensor", "energy_sensor", "wifi_status"]
    primary_attribute: power_switch.state
    requires: [topic]
    description: Shelly relay
    contributor_name: "Daniele Bochicchio <daniele@bochicchio.com>"
    license: MIT
    contributor_url: https://github.com/dbochicchio/reactor-mqtt-contrib
    query:
      topic: "shellies/%topic%/command"
      payload: "update"
      qos: 0
      retain: false
    events:
      "shellies/%topic%/roller/0":
        "power_switch.state":
          expr: "payload == 'open'"
        "cover.state":
          expr: "payload == 'open'"
        "position.value":
          expr: "payload == 'open'? 1 : 0"
          if_expr: "payload != 'stop'"
        "x_mqtt_device.online": true

      "shellies/%topic%/roller/0/pos":
        "position.value":
          expr: "float(payload) / 100"
          if_expr: "payload != '-1'"
        "x_mqtt_device.online": true

      "shellies/%topic%/roller/0/power":
        "power_sensor.value":
          expr: "float(payload)"
        "power_sensor.units": "W"
        "x_mqtt_device.online": true

      "shellies/%topic%/roller/0/energy":
        "energy_sensor.value":
          expr: "round(float(payload) / 0.06, 4)" # value / 60 / 1000
        "energy_sensor.units": "KWH"
        "x_mqtt_device.online": true

      "shellies/%topic%/online":
        "x_mqtt_device.online":
          expr: 'bool(payload)'

      "shellies/%topic%/info":
        "wifi_status.rssi":
          json_payload: true
          expr: "payload.wifi_sta.rssi"
        "wifi_status.ssid":
          json_payload: true
          expr: "payload.wifi_sta.ssid"
        "wifi_status.station_ip":
          json_payload: true
          expr: "payload.wifi_sta.ip"

    actions:
      power_switch:
        "on":
          topic: "shellies/%topic%/roller/0/command"
          payload: "open"
        "off":
          topic: "shellies/%topic%/roller/0/command"
          payload: "close"
        "set":
          topic: "shellies/%topic%/roller/0/command"
          payload:
            expr: "parameters.state ? 'open' : 'close'"
            type: raw
      # toggle.toggle is implemented by the default handler in MQTTController

      position:
        "set":
          topic: "shellies/%topic%/roller/0/command/pos"
          payload:
            expr: "float(parameters.value) * 100"
            type: raw

      cover:
        "open":
          topic: "shellies/%topic%/roller/0/command"
          payload: "open"
        "close":
          topic: "shellies/%topic%/roller/0/command"
          payload: "close"
        "stop":
          topic: "shellies/%topic%/roller/0/command"
          payload: "stop"