# shelly_plus_relay_simple.yaml
#
# Copyright (C) 2022-2025 Daniele Bochicchio, All Rights Reserved
# For updates see https://github.com/dbochicchio/reactor-mqtt-contrib
#
# *** IMPORTANT ***
# Every time you update the files, a restart is needed.
---
templates:
  # Shelly online template
  shelly_online_gen3:
    capabilities: ["x_mqtt_device"]
    requires: [topic]
    description: Shelly Gen3 Online status
    include:
      - shelly_wifi_gen3 # from MQTTController
    events:
      "%topic%/online":
        "x_mqtt_device.online":
          expr: 'bool(payload)'

  # Shelly relay (simple template)
  shelly_relay_gen3:
    type: Switch
    capabilities: ["power_switch", "toggle"]
    primary_attribute: power_switch.state
    requires: [topic, channel]
    description: Shelly Gen3 relay
    lwt: "%topic%/online"
    query:
      topic: "%topic%/command"
      payload: "status_update"
    include:
      - shelly_online_gen3
    events:
      # command-based events
      "%topic%/status/switch:%channel%":
        "power_switch.state":
          json_payload: true
          if_expr: "payload?.output !== null"
          expr: "bool( payload.output )"
        "x_mqtt_device.online": true

      # RPC-based events
      # {"src":"shellyplus1-cc7b5c87baa0","dst":"shellies/shelly-sprinklers-terrace/events","method":"NotifyStatus","params":{"ts":1716622594.36,"switch:0":{"id":0,"output":true,"source":"http","timer_duration":300.00,"timer_started_at":1716622594.37}}}
      "%topic%/events/rpc":
        "power_switch.state":
          json_payload: true
          if_expr: "(payload.method==='NotifyStatus' || payload.method==='NotifyFullStatus') && payload?.params?['switch:' + str(channel)]?.output !== null"
          expr: "bool( payload.params['switch:' + str(channel)].output )"
        "x_mqtt_device.online": true

    actions:
      power_switch:
        "on":
          topic: "%topic%/command/switch:%channel%"
          payload: "on"
        "off":
          topic: "%topic%/command/switch:%channel%"
          payload: "off"
        "set":
          topic: "%topic%/command/switch:%channel%"
          payload:
            expr: "parameters.state ? 'on' : 'off'"
            type: raw
      # toggle.toggle is implemented by the default handler in MQTTController

# Shelly relay with power meter
  shelly_relay_power_gen3:
    type: Switch
    capabilities: ["power_sensor", "energy_sensor", "voltage_sensor", "current_sensor"]
    primary_attribute: power_switch.state
    requires: [topic, channel]
    description: Shelly Gen3 relay with power meter
    lwt: "%topic%/online"
    query:
      topic: "%topic%/command"
      payload: "status_update"
    include:
      - shelly_relay_gen3
    events:
      "%topic%/events/rpc":
        "power_switch.state":
          json_payload: true
          if_expr: "(payload.method==='NotifyStatus' || payload.method==='NotifyFullStatus') && payload?.params?['switch:' + str(channel)]?.output !== null"
          expr: "bool( payload.params['switch:' + str(channel)].output )"
        "x_mqtt_device.online": true

      "%topic%/status/switch:%channel%":
        # "power_switch.state":
        #   json_payload: true
        #   if_expr: "payload?.output !== null"
        #   expr: "bool( payload.output )"

        "power_sensor.value":
          json_payload: true
          if_expr: "payload?.apower != null"
          expr: "float( payload.apower )"
        "power_sensor.units": "W"

        "energy_sensor.value":
          json_payload: true
          if_expr: "payload?.aenergy?.total != null"
          expr: "round(float( payload.aenergy.total) * 0.001, 4)" # Wh
        "energy_sensor.units": "KWH"

        "current_sensor.value":
          json_payload: true
          if_expr: "payload?.current != null"
          expr: "round(float( payload.current ), 2)"
        "current_sensor.units": "A"

        "voltage_sensor.value":
          json_payload: true
          if_expr: "payload?.voltage != null"
          expr: "round(float( payload.voltage ), 2)"
        "voltage_sensor.units": "V"
        "x_mqtt_device.online": true

  # Shelly dimmer with power meter (Gen3)
  shelly_dimmer_power_gen3:
    type: Light
    capabilities: ["power_switch", "toggle", "dimming", "power_sensor", "energy_sensor", "voltage_sensor", "current_sensor"]
    primary_attribute: power_switch.state
    requires: [topic, channel]
    description: Shelly Gen3 Dimmer with power meter
    lwt: "%topic%/online"
    query:
      topic: "%topic%/command"
      payload: "status_update"
    include:
      - shelly_online_gen3

    events:
      "%topic%/events/rpc":
        "dimming.level":
          json_payload: true
          if_expr: "(payload.method==='NotifyStatus' || payload.method==='NotifyFullStatus') && payload?.params?.['light' + str(channel)]?.brightness != null"
          expr: "int(payload.params['light:' + str(channel)].brightness) / 100"

        "power_switch.state":
          json_payload: true
          if_expr: "(payload.method==='NotifyStatus' || payload.method==='NotifyFullStatus') && payload?.params?.['light' + str(channel)]?.output != null"
          expr: "bool(payload.params['light' + str(channel)].output)"
        "x_mqtt_device.online": true

      "%topic%/status/light:%channel%":
        "power_switch.state":
          json_payload: true
          if_expr: "payload?.output != null"
          expr: "bool(payload.output)"

        "dimming.level":
          json_payload: true
          if_expr: "payload?.brightness != null"
          expr: "int(payload.brightness) / 100"

        "power_sensor.value":
          json_payload: true
          if_expr: "payload?.apower != null"
          expr: "float(payload.apower)"
        "power_sensor.units": "W"

        "energy_sensor.value":
          json_payload: true
          if_expr: "payload?.aenergy?.total != null"
          expr: "round(float(payload.aenergy.total) * 0.001, 4)" # Wh
        "energy_sensor.units": "KWH"

        "current_sensor.value":
          json_payload: true
          if_expr: "payload?.current != null"
          expr: "round(float(payload.current), 2)"
        "current_sensor.units": "A"

        "voltage_sensor.value":
          json_payload: true
          if_expr: "payload?.voltage != null"
          expr: "round(float(payload.voltage), 2)"
        "voltage_sensor.units": "V"

        "x_mqtt_device.online": true

    actions:
      power_switch:
        "on":
          topic: "%topic%/rpc"
          payload:
            expr: |
              {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": true
                }
              }
          type: json
        "off":
          topic: "%topic%/rpc"
          payload:
            expr: |
              {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": false
                }
              }
            type: json
        "set":
          topic: "%topic%/rpc"
          payload:
            expr: |
              {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": parameters.state
                }
              }
            type: json
      # toggle.toggle is implemented by the default handler in MQTTController

      dimming:
        "set":
          topic: "%topic%/rpc"
          payload:
            expr: |
             {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": parameters.level > 0,
                  "brightness": int(max(0, min(1, parameters.level)) * 100)
                }
              }
            type: json
        "up":
          topic: "%topic%/rpc"
          payload:
            expr: |
             {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": entity.attributes.dimming.level + 0.1 > 0,
                  "brightness": int(min(1, entity.attributes.dimming.level + 0.1) * 100)
                }
              }
            type: json
        "down":
          topic: "%topic%/rpc"
          payload:
            expr: |
             {
                "id" : 0,
                "src" : "reactor",
                "method": "Light.Set",
                "params" : {
                  "id": 0,
                  "on": entity.attributes.dimming.level - 0.1 > 0,
                  "brightness": int(max(0, entity.attributes.dimming.level - 0.1) * 100)
                }
              }
            type: json

  # Shelly 3EM Gen3
  shelly_3em_gen3:
    type: Sensor
    capabilities: ["power_sensor", "energy_sensor", "voltage_sensor", "current_sensor"]
    primary_attribute: power_sensor.value
    requires: [topic]
    description: Shelly Gen3 HEM (Home Energy Meter)
    lwt: "%topic%/online"
    query:
      topic: "%topic%/command"
      payload: "status_update"
    include:
      - shelly_online_gen3
    events:
      "%topic%/status/em:0":
        "power_sensor.value":
          json_payload: true
          if_expr: "payload?.total_act_power != null"
          expr: "float( payload.total_act_power )"
        "power_sensor.units": "W"

        "current_sensor.value":
          json_payload: true
          if_expr: "payload?.total_current != null"
          expr: "round(float(payload.total_current), 2)"
        "current_sensor.units": "A"

        "voltage_sensor.value":
          json_payload: true
          if_expr: "payload?.total_act_power != null"
          expr: "round(float(payload.total_act_power), 2)"
        "voltage_sensor.units": "V"

        "x_mqtt_device.online": true

      "%topic%/status/emdata:0":
        "energy_sensor.value":
          json_payload: true
          if_expr: "payload?.total_act != null"
          expr: "round(float(payload.total_act) / 1000, 4)" # from WH to KwH
        "energy_sensor.units": "KWH"

        "x_mqtt_device.online": true

  # Shelly HEM Gen3
  shelly_hem_gen3:
    type: Sensor
    capabilities: ["power_sensor", "energy_sensor", "voltage_sensor", "current_sensor"]
    primary_attribute: power_sensor.value
    requires: [topic, channel]
    description: Shelly Gen3 HEM (Home Energy Meter)
    lwt: "%topic%/online"
    query:
      topic: "%topic%/command"
      payload: "status_update"
    include:
      - shelly_online_gen3
    events:
      "%topic%/status/em1:%channel%":
        "power_sensor.value":
          json_payload: true
          if_expr: "payload?.act_power != null"
          expr: "float( payload.act_power )"
        "power_sensor.units": "W"

        "current_sensor.value":
          json_payload: true
          if_expr: "payload?.current != null"
          expr: "round(float(payload.current), 2)"
        "current_sensor.units": "A"

        "voltage_sensor.value":
          json_payload: true
          if_expr: "payload?.voltage != null"
          expr: "round(float(payload.voltage), 2)"
        "voltage_sensor.units": "V"

        "x_mqtt_device.online": true

      "%topic%/status/em1data:%channel%":
        "energy_sensor.value":
          json_payload: true
          if_expr: "payload?.total_act_energy != null"
          expr: "round(float(payload?.total_act_energy) / 1000, 4)" # from WH to KwH
        "energy_sensor.units": "KWH"

        "x_mqtt_device.online": true